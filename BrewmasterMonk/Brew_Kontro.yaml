version: 1.0
author: Kontroved
spec: 268
name: BrewMonk by Kontro
description: Brewmaster Monk Rotation by Kontroved

entry: main

morphs:
  invoke_niuzao_the_black_ox: mighty_stomp
  celestial_brew: celestial_infusion
  exploding_keg: empty_the_cellar

movement_allowed:

config:
  features:
    label: "Features"
    type: multi_select
    options:
      - label: "opener usage"
        value: 0
      - label: "PreCombat"
        value: 1
      - label: "Taunt Usage (Keg & Provoke)"
        value: 2
      - label: "Auto Swap (CC/Interrupt)"
        value: 3
      - label: "Tigers Lust on roots"
        value: 4
    default: [0,1,2,3,4]
  # Defensive Settings
  celestial_brew_hp_pct:
    label: "Celestial Brew HP %"
    type: slider
    min: 0
    max: 100
    default: 45

  expel_harm_pct:
    label: "Expel Harm HP %"
    type: slider
    min: 0
    max: 100
    default: 50

  fortifying_brew_pct:
    label: "Fortifying Brew HP % (recommend manual usage)"
    type: slider
    min: 0
    max: 100
    default: 20

  ttd_cd_usage:
    label: "TTD CD Usage Threshold"
    type: slider
    min: 0
    max: 30
    default: 10

variables:
    opener_usage: config.features.has(0)
    precombat_usage: config.features.has(1)
    taunt_usage: config.features.has(2)
    tigers_lust_usage: config.features.has(4)
    celestial_brew_pct: config.celestial_brew_hp_pct
    expel_harm_pct: config.expel_harm_pct
    light_stagger: stagger.pct<29
    moderate_stagger: stagger.pct>=30&stagger.pct<60
    heavy_stagger: stagger.pct>=80
    auto_swap: config.features.has(3)
lists:
  combat_checks:
    - return,if=!target.valid&!((config.auto_combat.has(1)&target.quest_mob&target.enemy&!target.dead)|(config.auto_combat.has(2)&target.combat&target.enemy&!target.dead)|(config.auto_combat.has(3)&target.targeting_party&target.enemy&!target.dead))
    - return,if=!target.valid&config.auto_combat.has(0)

  defensives:
    - tigers_lust,name="Tiger's Lust",if=player.rooted&tigers_lust_usage
    - purifying_brew,delay=500,name="Purifying Brew (High Charge)",if=cooldown.purifying_brew.charges_fractional>=1.8&stagger.pct>=20
    - purifying_brew,name="Purifying Brew (Heavy Stagger)",if=var.heavy_stagger&cooldown.purifying_brew.charges_fractional>=1
    - celestial_brew,name="Celestial Brew",if=var.heavy_stagger|health.pct<=var.celestial_brew_pct
    - fortifying_brew,name="Fortifying Brew",if=health.pct<=var.fortifying_brew_pct|var.heavy_stagger
   
  self_heals:
    - expel_harm,name="Expel Harm (Config HP)",if=health.pct<=var.expel_harm_pct&energy>=15
    - expel_harm,name="Expel Harm (30% HP)",if=health.pct<=30&energy>=15

  interrupts:
    - target_enemy,name="auto_target Interrupt",if=(interrupts.5y.ready|interrupts.8y.count>=1)&!interrupts.target.ready&cooldown.spear_hand_strike.ready&enemies.inrange(5)>=1&var.auto_swap
    - target_enemy,name="auto_target Stun",if=interrupts.10y.stun.ready&!interrupts.target.stun.ready&cooldown.paralysis.ready&enemies.inrange(10)>=1&var.auto_swap
       # Primary Interrupt
    - spear_hand_strike,name="Interrupt Target",if=config.interrupt_target&(config.interrupt_all&target.casting.interruptible|interrupts.target.ready)&target.casting.elapsed>=0.2&(target.casting.remains<1|target.channeling)
    - spear_hand_strike.mouseover,name="Interrupt Mouseover",if=config.interrupt_mouseover&(config.interrupt_all&mouseover.casting.interruptible|interrupts.mouseover.ready)&interrupts.mouseover.ready&mouseover.casting.elapsed>=0.2&(mouseover.casting.remains<1|mouseover.channeling)
    - spear_hand_strike.focus,name="Interrupt Focus",if=config.interrupt_focus&(config.interrupt_all&focus.casting.interruptible|interrupts.focus.ready)&interrupts.focus.ready&focus.casting.elapsed>=0.2&(focus.casting.remains<1|focus.channeling)
       # CC Interrupt
    - paralysis,name="Paralysis Target (CC)",if=interrupts.target.stun.ready&target.casting.elapsed>=0.5
    #- paralysis.mouseover,name="Paralysis Mouseover (CC)",if=interrupts.mouseover.stun.ready&mouseover.casting.elapsed>=0.5
       # AoE Interrupt
    - leg_sweep,name="Leg Sweep (AoE)",if=((interrupts.10y.stun.count>=2|interrupts.10y.count>=2)&talent.tiger_tail_sweep)|(interrupts.6y.stun.count>=2|interrupts.6y.count>=2)

  pre_combat:
    - breath_of_fire,name="BoF Pre-Combat",range_check=none,if=!buff.charred_passions.up
    - rushing_jade_wind,name="RJW Pre-Combat",range_check=none,if=!buff.rushing_jade_wind.up

  taunt:
    - provoke,name="Taunt",if=target.threat<2&target.combat&target.threat!=-1
    - provoke,name="Taunt MO",if=mouseover.threat<2&mouseover.combat&mouseover.threat!=-1&mouseover.exists
    #- keg_smash,name="Keg Taunt",if=target.threat<2&target.combat&target.threat!=-1&cooldown.provoke.remains>1
    #- keg_smash.mouseover,name="Keg Taunt MO",if=mouseover.threat<2&mouseover.combat&mouseover.threat!=-1&cooldown.provoke.remains>1

  opener:
    - chi_burst,name="Chi Burst (Opener)"
    - keg_smash,name="Keg Smash (Opener)"
    - blackout_kick,name="Blackout Kick (Opener)",if=!buff.blackout_combo.up
    - breath_of_fire,name="BoF (Opener)",if=buff.charred_passions.remains<=2
    - tiger_palm,name="Tiger Palm (Opener)",if=buff.blackout_combo.up
    - exploding_keg,name="Exploding Keg (Opener)",if=player.moving
    - keg_smash,name="Keg Smash (Opener Final)"

  niuzao_window:
    - blackout_kick,name="Blackout Kick (Niuzao)",if=buff.invoke_niuzao_the_black_ox.up&!buff.blackout_combo.up
    - breath_of_fire,name="BoF (Niuzao)",if=buff.invoke_niuzao_the_black_ox.up&talent.flurry_strikes&(!buff.charred_passions.up|buff.charred_passions.remains<=2)
    - mighty_stomp,name="Mighty Stomp (Niuzao)",if=buff.invoke_niuzao_the_black_ox.up&talent.mighty_stomp

  st:
    - empty_the_cellar,override=exploding_keg,ignore_usable=true,ignore_cooldown=true,if=buff.empty_the_cellar.up
    - call_action_list,name=niuzao_window
    - black_ox_brew,name="Black Ox Brew (ST)",if=energy.deficit>=40&cooldown.purifying_brew.charges_fractional<1&cooldown.celestial_brew.remains>10
    - touch_of_death,name="Touch of Death (ST)"
    - blackout_kick,name="Blackout Kick (ST)",if=!buff.blackout_combo.up
    - invoke_niuzao_the_black_ox,name="Invoke Niuzao (ST)",if=fight_remains>=25&fight_remains!=9999
    - breath_of_fire,name="BoF (ST)",if=!buff.charred_passions.up|buff.charred_passions.remains<=2
    - tiger_palm,name="Tiger Palm (ST Combo)",if=buff.blackout_combo.up
    - keg_smash,name="Keg Smash (ST shado_panw)",if=talent.flurry_strikes&cooldown.keg_smash.charges_fractional>=1.8
    - rushing_jade_wind,name="RJW (ST Before Keg)",if=cooldown.exploding_keg.remains<=gcd
    - exploding_keg.player,name="Exploding Keg (ST)",if=(buff.rushing_jade_wind.up|!cooldown.rushing_jade_wind.up)|!talent.rushing_jade_wind&active_enemies>=1
    - chi_burst,name="Chi Burst (ST shado_panw)",if=talent.flurry_strikes
    - keg_smash,name="Keg Smash (ST Main)"
    - rushing_jade_wind,name="RJW (ST Main)",if=!buff.rushing_jade_wind.up
    - tiger_palm,name="Tiger Palm (ST Filler)",if=cooldown.keg_smash.remains>gcd&(energy>=80|energy.time_to_80<=cooldown.keg_smash.remains)

  aoe:
    - empty_the_cellar,override=exploding_keg,ignore_usable=true,ignore_cooldown=true,if=buff.empty_the_cellar.up
    - call_action_list,name=niuzao_window
    - black_ox_brew,name="Black Ox Brew (AoE)",if=energy.deficit>=40&cooldown.purifying_brew.charges_fractional<1&cooldown.celestial_brew.remains>10
    - touch_of_death,name="Touch of Death (AoE)"
    - blackout_kick,name="Blackout Kick (AoE)",if=!buff.blackout_combo.up
    - invoke_niuzao_the_black_ox,name="Invoke Niuzao (AoE)",if=fight_remains>=25&fight_remains!=9999
    - breath_of_fire,name="BoF (AoE)",if=!buff.charred_passions.up|buff.charred_passions.remains<=2
    - tiger_palm,name="Tiger Palm (AoE Combo)",if=buff.blackout_combo.up
    - keg_smash,name="Keg Smash (AoE shado_panw)",if=talent.flurry_strikes&cooldown.keg_smash.charges_fractional>=1.8
    - chi_burst,name="Chi Burst (AoE shado_panw)",if=talent.flurry_strikes
    - rushing_jade_wind,name="RJW (AoE Before Keg)",if=cooldown.exploding_keg.remains<=gcd
    - exploding_keg.player,name="Exploding Keg (AoE)",if=(buff.rushing_jade_wind.up|!cooldown.rushing_jade_wind.up)|!talent.rushing_jade_wind&active_enemies>=1
    - keg_smash,name="Keg Smash (AoE Main)"
    - rushing_jade_wind,name="RJW (AoE Main)",if=!buff.rushing_jade_wind.up
    - spinning_crane_kick,name="Spinning Crane Kick (AoE)",if=cooldown.keg_smash.remains>gcd&(energy>=60|energy.time_to_60<=cooldown.keg_smash.remains)
    - tiger_palm,name="Tiger Palm (AoE Filler)",if=cooldown.keg_smash.remains>gcd&(energy>=80|energy.time_to_80<=cooldown.keg_smash.remains)

  main:
    - call_action_list,name=pre_combat,if=target.enemy&target.alive&var.precombat_usage&!player.combat&!state.rotation
    - call_action_list,name=spell_queue
    - call_action_list,name=sanity_checks
    - call_action_list,name=auto_heal
    - call_action_list,name=pre_combat,if=target.enemy&target.alive&var.precombat_usage&!player.combat
    - call_action_list,name=combat_checks
    - call_action_list,name=interrupts
    - call_action_list,name=auto_target
    - call_action_list,name=taunt, if=var.taunt_usage
    - call_action_list,name=defensives
    - call_action_list,name=self_heals
    - call_action_list,name=opener,if=combat.time<gcd*8&var.opener_usage
    - call_action_list,name=aoe,if=active_enemies>=2
    - call_action_list,name=st
