version: 1.2
author: Kontroved
spec: 581
name: Vengeance
description: "Vengeance Demon Hunter by Kontroved"

entry: main
config:
  features2:
    label: "Features"
    type: multi_select
    options:
      - label: "Demon Spikes Spam"
        value: 0
      - label: "Meta DPS Usage"
        value: 1
      - label: "Fiery Brand Spam (DPS Boost)"
        value: 2
      - label: "Fel Devastation Movement Check"
        value: 3
      - label: "Sigil of Flame Movement Check"
        value: 4
      - label: "Felblade Melee Only"
        value: 5
      - label: "Pull MO Combat WIP"
        value: 6
      - label: "Infernal Strike player"
        value: 7
      - label: "Auto Swap (CC/Interrupt)"
        value: 8
    default: [0,1,2,3,4,5,6,7,8]
    show_override: true
  # Defensive Settings
  demon_spikes_hp_pct:
    label: "Demon Spikes HP%"
    type: slider
    min: 0
    max: 100
    default: 99

  fel_devastation_hp_pct:
    label: "Fel Devastation HP%"
    type: slider
    min: 0
    max: 100
    default: 60

  metamorphosis_hp_pct:
    label: "Metamorphosis HP%"
    type: slider
    min: 0
    max: 100
    default: 40

  darkness_hp_pct:
    label: "Darkness HP%"
    type: slider
    min: 0
    max: 100
    default: 30

  ttd_cd_usage:
    label: "TTD CD Usage Threshold"
    type: slider
    min: 0
    max: 30
    default: 10

variables:
  ## Features
  demon_spikes_spam: config.features2.has(0)
  meta_dps_usage: config.features2.has(1)
  fel_devastation_movementcheck: config.features2.has(3)
  sigil_movement_check: config.features2.has(4)
  felblade_melee_only: config.features2.has(5)
  fiery_brand_spam: config.features2.has(2)
  pull_mo_combat: config.features2.has(6)
  infernal_strike_player: config.features2.has(7)
  auto_swap: config.features2.has(8)
  ## State tracking
  has_defensive: buff.metamorphosis.up|debuff.fiery_brand.up
  soul_fragments: buff.soul_fragments.stack
  fel_met: cooldown.fell_devastation.up&health.pct<=config.fel_devastation_hp_pct
  interrupt_swap_going: (interrupts.10y.ready|interrupts.10y.count>=1)&!interrupts.target.ready&cooldown.disrupt.ready&enemies.inrange(10)>=1&var.auto_swap
  #APL
  fiery_demise_active: talent.fiery.brand&talent.fiery_demise&debuff.fiery_brand.up
  ur_fishing: talent.untethered_rage&buff.metamorphosis.up&buff.metamorphosis.remains<8&!buff.untethered_rage.up
  fallout_aoe: talent.fallout&active_enemies>=3

lists:
  combat_checks:
    - return,if=!target.valid&!((config.auto_combat.has(1)&target.quest_mob&target.enemy&!target.dead)|(config.auto_combat.has(2)&target.combat&target.enemy&!target.dead)|(config.auto_combat.has(3)&target.targeting_party&target.enemy&!target.dead))
    - return,if=!target.valid&config.auto_combat.has(0)

  defensives:
    - immolation_aura,if=active_enemies>=1
    - demon_spikes,if=var.demon_spikes_spam&buff.demon_spikes.down|buff.demon_spikes.remains<1
    - demon_spikes,if=health.pct<=config.demon_spikes_hp_pct&buff.demon_spikes.remains<1&!buff.metamorphosis.up&!debuff.fiery_brand.up
    - fel_devastation,if=health.pct<=config.fel_devastation_hp_pct
    - metamorphosis,if=health.pct<=config.metamorphosis_hp_pct&!buff.metamorphosis.up&!debuff.fiery_brand.up
    - darkness,if=health.pct<=config.darkness_hp_pct&!buff.metamorphosis.up&!debuff.fiery_brand.up

  interrupts:
    #- target_enemy,name="auto_target Stun",if=interrupts.10y.stun.ready&!interrupts.target.stun.ready&cooldown.paralysis.ready&enemies.inrange(10)>=1&var.auto_swap
    - disrupt,if=config.interrupt_target&(config.interrupt_all&target.casting.interruptible|interrupts.target.ready)&target.casting.elapsed>=0.2&(target.casting.remains<1|target.channeling)
    - disrupt.mouseover,if=config.interrupt_mouseover&(config.interrupt_all&mouseover.casting.interruptible|interrupts.mouseover.ready)&interrupts.mouseover.ready&mouseover.casting.elapsed>=0.2&(mouseover.casting.remains<1|mouseover.channeling)
    - disrupt.focus,if=config.interrupt_focus&(config.interrupt_all&focus.casting.interruptible|interrupts.focus.ready)&interrupts.focus.ready&focus.casting.elapsed>=0.2&(focus.casting.remains<1|focus.channeling)
      # CC Interrupt
    - imprison,if=interrupts.target.stun.ready&target.casting.elapsed>=0.5
    - imprison.mouseover,if=interrupts.mouseover.stun.ready&mouseover.casting.elapsed>=0.5
      # AoE Interrupt
    - chaos_nova,if=interrupts.8y.stun.count>=2|interrupts.8y.count>=2
    - sigil_of_silence.player,if=interrupts.8y.count>=2&cooldown.chaos_nova.remains>gcd+1
    - sigil_of_misery.player,if=(interrupts.8y.stun.count>=2|interrupts.8y.count>=2)&cooldown.chaos_nova.remains>gcd+1
    - target_enemy,delay=300,name="range tab, if target ! casting",if=!interrupts.target.ready&target.range>8&!var.interrupt_swap_going&enemies.8y>=1
    - target_enemy,delay=100,name="auto_target Interrupt",if=(interrupts.8y.ready|interrupts.8y.count>=1)&!interrupts.target.ready&enemies.inrange(10)>=1&var.auto_swap

  taunt:
    - torment,name="Taunt",if=target.threat<2&target.combat&target.threat!=-1
    - torment.mouseover,name="Taunt MO",if=mouseover.threat<2&mouseover.combat&mouseover.threat!=-1&mouseover.exists

  #Development Area APL based
  ur_fishing:
    - spirit_bomb,if=buff.seething_anger.up&var.soul_fragments>=3
    - spirit_bomb,if=var.soul_fragments>=4
    - sigil_of_spite.player,if=var.soul_fragments<=2&enemies.8y>=1&!player.moving
    - soul_carver,if=var.soul_fragments<=2
    - fracture
    - soul_cleave,if=var.soul_fragments>=1
  
  fillers:
    - immolation_aura,name="filler"
    - vengeful_retreat,name="filler",if=talent.unhindered_assault
    - throw_glaive,name="filler"

  ar:
    - metamorphosis,if=config.features2.has(1)&(!buff.metamorphosis.up&var.soul_fragments>=3)|buff.untethered_rage.up
    - call_action_list,name=ar_empowered
    - call_action_list,name=ar_brand_window,if=var.fiery_demise_active
    - call_action_list,name=ur_fishing,if=var.ur_fishing
    - call_action_list,name=ar_cooldowns
    - call_action_list,name=ar_aoe,if=var.fallout_aoe
    - fracture,if=debuff.reavers_mark.up&active_enemies=1&((buff.metamorphosis.up&var.soul_fragments<4)|(!buff.metamorphosis.up&var.soul_fragments<5))
    - fracture,if=cooldown.fracture.full_recharge_time<gcd.max&((buff.metamorphosis.up&var.soul_fragments<4)|(!buff.metamorphosis.up&var.soul_fragments<5))&(!var.fiery_demise_active|active_enemies>=3)
    - spirit_bomb,if=var.soul_fragments>=3&var.fiery_demise_active
    - spirit_bomb,if=(buff.metamorphosis.up&var.soul_fragments>=4)|(!buff.metamorphosis.up&var.soul_fragments>=5)
    - fracture
    - felblade,if=(target.range<5|!config.features2.has(5))
    - immolation_aura,if=talent.fallout
    - sigil_of_flame.player,if=(!player.moving|!config.features2.has(4))&enemies.8y>=1
    - soul_cleave
    - call_action_list,name=fillers

  ar_empowered:
    - reavers_glaive,if=buff.reavers_glaive.up&!buff.rending_strike.up&!buff.glaive_flurry.up
    - fracture,if=buff.rending_strike.up&buff.glaive_flurry.up&active_enemies>=3
    - soul_cleave,if=buff.rending_strike.up&buff.glaive_flurry.up
    - fracture,if=buff.rending_strike.up&!buff.glaive_flurry.up
    - soul_cleave,if=buff.glaive_flurry.up&!buff.rending_strike.up

  ar_cooldowns:
    - fiery_brand,if=talent.fiery_demise&(cooldown.fiery_brand.charges>=2|(!dot.fiery_brand.ticking&(cooldown.soul_carver.remains<6|cooldown.fel_devastation.remains<6|cooldown.sigil_of_spite.remains<6)))
    - sigil_of_spite.player,if=var.soul_fragments<=3&!player.moving&enemies.8y>=1
    - soul_carver,if=!talent.fiery_demise|var.fiery_demise_active
    - fel_devastation,if=!buff.rending_strike.up&!buff.glaive_flurry.up&(!player.moving|!config.features2.has(3))
 
  ar_aoe:
    - immolation_aura,if=!buff.immolation_aura.up
    - spirit_bomb,if=(buff.metamorphosis.up&var.soul_fragments>=4)|(!buff.metamorphosis.up&var.soul_fragments>=5)
    - fracture,if=buff.metamorphosis.up
    - sigil_of_flame.player,if=(!player.moving|!config.features2.has(4))&enemies.8y>=1
    - fracture
    - felblade, if=(target.range<5|!config.features2.has(5))
    - soul_cleave
    - call_action_list,name=fillers
    
  ar_brand_window:
    - spirit_bomb,if=var.soul_fragments>=3&!debuff.frailty.up
    - immolation_aura,if=talent.charred_flesh&!buff.immolation_aura.up
    - soul_carver
    - sigil_of_spite.player,if=var.soul_fragments<=3&enemies.8y>=1&!player.moving
    - fel_devastation,if=!buff.rending_strike.up&!buff.glaive_flurry.up&(!player.moving|!config.features2.has(3))
    - immolation_aura,if=!talent.charred_flesh

  anni:
    - call_action_list,name=anni_voidfall
    - metamorphosis,name="1 - Metamorphosis",if=config.features2.has(1)&(!buff.metamorphosis.up|buff.untethered_rage.up)&!buff.voidfall_spending.up&buff.voidfall_building.stack<2
    - call_action_list,name=ur_fishing,if=var.ur_fishing
    - fiery_brand,name="2 - Fiery Brand",if=talent.fiery_demise&!dot.fiery_brand.ticking&var.fiery_brand_spam&!buff.metamorphosis.up
    - immolation_aura,name="3 - Immolation Aura (Charred Flesh)",if=talent.charred_flesh&dot.fiery_brand.ticking
    - sigil_of_spite.player,name="4 - Sigil of Spite",if=var.soul_fragments<=2&!player.moving&enemies.8y>=1
    - soul_carver,name="5 - Soul Carver",if=talent.soul_carver&var.soul_fragments<=3
    - fel_devastation,name="6 - Fel Devastation",if=!buff.voidfall_spending.up&(!player.moving|!config.features2.has(3))
    - fracture,name="7 - Fracture (Recharge)",if=cooldown.fracture.full_recharge_time<gcd.max&((buff.metamorphosis.up&var.soul_fragments<4)|(!buff.metamorphosis.up&var.soul_fragments<5))
    - spirit_bomb,name="8 - Spirit Bomb",if=(buff.metamorphosis.up&var.soul_fragments>=4)|(!buff.metamorphosis.up&var.soul_fragments>=5)
    - fracture,name="9 - Fracture (No Voidfall)",if=!buff.voidfall_spending.up
    - felblade,name="10 - Felblade",if=(target.range<5|!config.features2.has(5))
    - immolation_aura,name="11 - Immolation Aura (Fallout)",if=talent.fallout
    - sigil_of_flame.player,name="12 - Sigil of Flame",if=(!player.moving|!config.features2.has(4))&enemies.8y>=1
    - soul_cleave,name="13 - Soul Cleave"
    - fracture,name="14 - Fracture"
    - call_action_list,name=fillers

  anni_voidfall: 
    - fiery_brand,name="Void: 1 - Fiery Brand",if=talent.fiery_demise&!debuff.fiery_brand.up&(buff.voidfall.stack=2|buff.voidfall.stack=3)&!buff.metamorphosis.up
    - fel_devastation,name="Void: 2 - Fel Devastation",if=buff.voidfall.stack=3&var.soul_fragments<((buff.metamorphosis.up&4)|(!buff.metamorphosis.up&5))
    - spirit_bomb,name="Void: 3 - Spirit Bomb",if=buff.voidfall.stack=3&((buff.metamorphosis.up&var.soul_fragments>=4)|(!buff.metamorphosis.up&var.soul_fragments>=5))
    - soul_cleave,name="Void: 4 - Soul Cleave",if=buff.voidfall.up&buff.voidfall.stack<3
    - fracture,name="Void: 5 - Fracture",if=buff.voidfall_building.stack=2&fury>=70

  main:
    - call_action_list,name=spell_queue
    - call_action_list,name=sanity_checks
    - call_action_list,name=auto_heal
    - call_action_list,name=combat_checks
    - call_action_list,name=defensives
    - call_action_list,name=taunt
    - call_action_list,name=interrupts
    - call_action_list,name=auto_target
    - infernal_strike.player,if=var.infernal_strike_player&target.range<=5&cooldown.infernal_strike.charges=2&!player.player.moving
    - call_action_list,name=ar,if=talent.art_of_the_glaive
    - call_action_list,name=anni
